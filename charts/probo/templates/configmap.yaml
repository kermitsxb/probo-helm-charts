apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "probo.fullname" . }}
  labels:
    {{- include "probo.labels" . | nindent 4 }}
data:
  config.yml: |
    unit:
      metrics:
        addr: "0.0.0.0:{{ .Values.probo.metrics.port }}"
      {{- if .Values.probo.tracing.enabled }}
      tracing:
        addr: {{ .Values.probo.tracing.addr | quote }}
        max-batch-size: {{ .Values.probo.tracing.maxBatchSize }}
        batch-timeout: {{ .Values.probo.tracing.batchTimeout }}
        export-timeout: {{ .Values.probo.tracing.exportTimeout }}
        max-queue-size: {{ .Values.probo.tracing.maxQueueSize }}
      {{- end }}

    probod:
      hostname: {{ .Values.probo.hostname | quote }}
      encryption-key: {{ .Values.probo.encryptionKey | quote }}
      chrome-dp-addr: {{ include "probo.chrome.addr" . | quote }}

      api:
        addr: "0.0.0.0:{{ .Values.service.port }}"
        cors:
          allowed-origins:
            {{- toYaml .Values.probo.cors.allowedOrigins | nindent 12 }}
        {{- if .Values.probo.extraHeaderFields }}
        extra-header-fields:
          {{- toYaml .Values.probo.extraHeaderFields | nindent 10 }}
        {{- end }}

      pg:
        addr: "{{ include "probo.postgresql.host" . }}:{{ include "probo.postgresql.port" . }}"
        username: {{ include "probo.postgresql.username" . | quote }}
        password: {{ include "probo.postgresql.password" . | quote }}
        database: {{ include "probo.postgresql.database" . | quote }}
        pool-size: {{ .Values.postgresql.poolSize }}
        {{- if .Values.postgresql.caCertBundle }}
        ca-cert-bundle: |
          {{- .Values.postgresql.caCertBundle | nindent 10 }}
        {{- end }}

      auth:
        disable-signup: {{ .Values.probo.auth.disableSignup }}
        invitation-confirmation-token-validity: {{ .Values.probo.auth.invitationTokenValidity }}
        cookie:
          name: {{ .Values.probo.auth.cookieName | quote }}
          domain: {{ .Values.probo.auth.cookieDomain | quote }}
          secret: {{ .Values.probo.auth.cookieSecret | quote }}
          duration: {{ .Values.probo.auth.cookieDuration }}
        password:
          pepper: {{ .Values.probo.auth.passwordPepper | quote }}
          iterations: {{ .Values.probo.auth.passwordIterations }}

      trust-auth:
        cookie-name: {{ .Values.probo.trustAuth.cookieName | quote }}
        cookie-domain: {{ .Values.probo.trustAuth.cookieDomain | quote }}
        cookie-duration: {{ .Values.probo.trustAuth.cookieDuration }}
        token-duration: {{ .Values.probo.trustAuth.tokenDuration }}
        report-url-duration: {{ .Values.probo.trustAuth.reportUrlDuration }}
        {{- if .Values.probo.trustAuth.ports }}
        ports:
          http-challenge: {{ .Values.probo.trustAuth.ports.httpChallenge }}
          tls-http-server: {{ .Values.probo.trustAuth.ports.tlsHttpServer }}
        {{- end }}
        token-secret: {{ .Values.probo.trustAuth.tokenSecret | quote }}
        scope: {{ .Values.probo.trustAuth.scope | quote }}
        token-type: {{ .Values.probo.trustAuth.tokenType | quote }}

      aws:
        region: {{ .Values.s3.region | quote }}
        bucket: {{ .Values.s3.bucket | quote }}
        access-key-id: {{ .Values.s3.accessKey | quote }}
        secret-access-key: {{ .Values.s3.secretKey | quote }}
        {{- $s3Endpoint := include "probo.s3.endpoint" . }}
        {{- if $s3Endpoint }}
        endpoint: {{ $s3Endpoint | quote }}
        {{- end }}

      mailer:
        sender-name: {{ .Values.probo.mailer.senderName | quote }}
        sender-email: {{ .Values.probo.mailer.senderEmail | quote }}
        smtp:
          addr: {{ .Values.probo.mailer.smtp.addr | quote }}
          {{- if .Values.probo.mailer.smtp.user }}
          user: {{ .Values.probo.mailer.smtp.user | quote }}
          {{- end }}
          {{- if .Values.probo.mailer.smtp.password }}
          password: {{ .Values.probo.mailer.smtp.password | quote }}
          {{- end }}
          tls-required: {{ .Values.probo.mailer.smtp.tlsRequired }}

      {{- if .Values.probo.openai.apiKey }}
      openai:
        api-key-from-env: "OPENAI_API_KEY"
        temperature: {{ .Values.probo.openai.temperature }}
        model-name: {{ .Values.probo.openai.modelName | quote }}
      {{- end }}

      {{- if .Values.probo.customDomains.enabled }}
      custom-domains:
        renewal-interval: {{ .Values.probo.customDomains.renewalInterval }}
        provision-interval: {{ .Values.probo.customDomains.provisionInterval }}
        cname-target: {{ .Values.probo.customDomains.cnameTarget | quote }}
        acme:
          directory: {{ .Values.probo.customDomains.acme.directory | quote }}
          email: {{ .Values.probo.customDomains.acme.email | quote }}
          key-type: {{ .Values.probo.customDomains.acme.keyType | quote }}
          insecure-tls: {{ .Values.probo.customDomains.acme.insecureTls }}
      {{- end }}

      {{- if .Values.probo.connectors }}
      connectors:
        {{- toYaml .Values.probo.connectors | nindent 8 }}
      {{- end }}
